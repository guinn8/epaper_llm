/**
 * @file app_main.c
 * @brief Application code built on the Nucleo-F411RE board and STM32Cube autogenerated code.
 * @date 2024-06-27
 */

#include <assert.h>
#include <stdarg.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

#include "driver_esp8266.h"
#include "main.h"
#include "stm32f4xx_hal_uart.h"
#include "usart.h"

static UART_HandleTypeDef *modem_uart = &huart1;
static char resp[1024] = {0};
static uint16_t read_index = 0;
volatile uint16_t write_index = 0;
static uint16_t start_at_cmd = 0;

void copy_string_from_circular_buffer(char *response, size_t response_len) {
    size_t len = (write_index >= start_at_cmd) ? (write_index - start_at_cmd) : (sizeof(resp) - start_at_cmd + write_index);
    len = (len > response_len - 1) ? (response_len - 1) : len;
    strncpy(response, &resp[start_at_cmd], len);
    response[len] = '\0';
}

bool send_at_command_and_check_response(char *cmd, char *expected_response, char *response, size_t response_len) {
    HAL_UART_Transmit(modem_uart, (uint8_t *)cmd, strlen(cmd), HAL_MAX_DELAY);

    uint32_t start_tick = HAL_GetTick();
    start_at_cmd = read_index;
    while ((HAL_GetTick() - start_tick) < 30000) {
        write_index = (sizeof(resp) - __HAL_DMA_GET_COUNTER(modem_uart->hdmarx)) % sizeof(resp);
        while (read_index != write_index) {
            putchar(resp[read_index]);
            if (strncmp(&resp[read_index], expected_response, strlen(expected_response)) == 0) {
                printf("Received %s for %s\r\n", expected_response, cmd);
                read_index += strlen(expected_response);
                copy_string_from_circular_buffer(response, response_len);
                return true;
            }
            read_index = (read_index + 1) % sizeof(resp);
        }
        HAL_Delay(10);
    }

    printf("Command %s failed!\r\n", cmd);
    return false;
}

int app_main(void) {
    printf("\n\r(%s:%d) START PROGRAM\n\r", __FILE__, __LINE__);
    HAL_UART_Receive_DMA(modem_uart, (uint8_t *)resp, sizeof(resp));

    char response[1024] = {0};
    if (send_at_command_and_check_response("AT+RST\r\n", "ready", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    if (send_at_command_and_check_response("AT\r\n", "OK", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    if (send_at_command_and_check_response("AT+CWMODE_CUR=3\r\n", "OK", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    if (send_at_command_and_check_response("AT+CWJAP_CUR=\"tiglath\",\"thedog123\"\r\n", "OK", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    if (send_at_command_and_check_response("AT+CIFSR\r\n", "OK", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    if (send_at_command_and_check_response("AT+CIPMUX=0\r\n", "OK", response, sizeof(response))) {
        // printf("%s\n\r", response);
    }

    while (1) {
        if (send_at_command_and_check_response("AT+PING=\"10.0.0.94\"\r\n", "OK", response, sizeof(response))) { // 93.184.216.34
            break;
        }
        
        HAL_Delay(10000);
    }

    while (1) { // , "",
        if (send_at_command_and_check_response("AT+CIPSTART=\"TCP\",\"10.0.0.94\",8080\r\n", "OK", response, sizeof(response))) { // 93.184.216.34
            break;
        }
        
        HAL_Delay(10000);
    }

    if (send_at_command_and_check_response("AT+CIPMODE=1\r\n", "OK", response, sizeof(response))) { 
        
    }
    
    if (send_at_command_and_check_response("AT+CIPSEND\r\n", "OK", response, sizeof(response))) { 
        
    }
    
    while (1)
    {
        if (send_at_command_and_check_response("hello world!\r\n", "OK", response, sizeof(response))) { 
        
    }
    }
    


    
     

}
