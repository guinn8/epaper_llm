/**
 * @file app_main.c
 * @author
 * @brief Application code built on the Nucleo-F411RE board and STM32Cube
 * autogenerated code.
 * @date 2024-06-27
 *
 * @copyright Copyright (c) 2024
 *
 */

#include <assert.h>
#include <stdarg.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "main.h"
#include "peripheral_init.h"
#include "stm32f4xx_hal_uart.h"
#include "driver_esp8266.h"

extern void SystemClock_Config(void); // grabs auto-generated function from main.c
static UART_HandleTypeDef *printf_uart = NULL;

int __io_putchar(int ch) {
  uint8_t c = ch;
  HAL_UART_Transmit(printf_uart, &c, 1, HAL_MAX_DELAY);
  return ch;
}

int __io_getchar(void) {
  uint8_t c;
  HAL_UART_Receive(printf_uart, &c, 1, HAL_MAX_DELAY);
  return c;
}


int main(void) {
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();
  UART_HandleTypeDef * uart1 = MX_USART1_UART_Init();
  UART_HandleTypeDef * uart2 = MX_USART2_UART_Init();
  printf_uart = uart2;

  while (1) {
    uint8_t cmd[] = "AT";
    uint8_t resp[128] = {0};
    if (NULL == AT_Command(uart1, cmd, resp, sizeof(resp))) {
      printf("AT command failed!\n\r");
    } else {
      printf("Response: %s\n\r", resp);
    }
    HAL_Delay(1000);
  }
}
